#!/usr/bin/env python3

import json
import sys
from typing import Any, Dict


def _send(message: Dict[str, Any]) -> None:
    sys.stdout.write(json.dumps(message) + "\n")
    sys.stdout.flush()


def _main() -> int:
    args = sys.argv[1:]
    if len(args) != 1 or args[0] != "app-server":
        sys.stderr.write("usage: fake-codex-steer app-server\n")
        return 2

    thread_id = "thr_cap"
    is_initialized = False
    is_thread_started = False
    active_turn_id = None
    turn_counter = 0

    for raw_line in sys.stdin:
        line = raw_line.strip()
        if not line:
            continue

        try:
            msg: Dict[str, Any] = json.loads(line)
        except Exception:
            continue

        msg_id = msg.get("id")
        method = msg.get("method")
        params: Dict[str, Any] = msg.get("params") or {}
        result = msg.get("result")
        error = msg.get("error")

        is_request = msg_id is not None and method is not None and result is None and error is None
        is_notification = msg_id is None and method is not None and result is None and error is None

        if is_notification:
            if method == "initialized":
                is_initialized = True
            continue

        if not is_request:
            continue

        if method == "initialize":
            _send(
                {
                    "jsonrpc": "2.0",
                    "id": msg_id,
                    "result": {
                        "capabilities": {
                            "turnSteer": True,
                            "followUpSuggestions": {"version": 1},
                        }
                    },
                }
            )
            continue

        if not is_initialized:
            _send(
                {
                    "jsonrpc": "2.0",
                    "id": msg_id,
                    "error": {
                        "code": -32002,
                        "message": "not initialized",
                        "data": None,
                    },
                }
            )
            continue

        if method == "account/read":
            _send(
                {
                    "jsonrpc": "2.0",
                    "id": msg_id,
                    "result": {"requiresOpenaiAuth": True, "account": {"type": "apikey"}},
                }
            )
            continue

        if method == "thread/start":
            is_thread_started = True
            _send({"jsonrpc": "2.0", "id": msg_id, "result": {"thread": {"id": thread_id}}})
            _send({"jsonrpc": "2.0", "method": "thread/started", "params": {"thread": {"id": thread_id}}})
            continue

        if method == "turn/start":
            requested_thread_id = params.get("threadId")
            if not is_thread_started or requested_thread_id != thread_id:
                _send(
                    {
                        "jsonrpc": "2.0",
                        "id": msg_id,
                        "error": {
                            "code": -32010,
                            "message": f"unknown threadId: {requested_thread_id}",
                            "data": None,
                        },
                    }
                )
                continue

            turn_counter += 1
            active_turn_id = f"turn_cap_{turn_counter}"
            _send({"jsonrpc": "2.0", "id": msg_id, "result": {"turn": {"id": active_turn_id}}})
            _send(
                {
                    "jsonrpc": "2.0",
                    "method": "turn/started",
                    "params": {"threadId": thread_id, "turn": {"id": active_turn_id}},
                }
            )
            _send(
                {
                    "jsonrpc": "2.0",
                    "method": "turn/followUpsSuggested",
                    "params": {
                        "threadId": thread_id,
                        "turnId": active_turn_id,
                        "suggestions": [
                            {"id": f"s_{turn_counter}_1", "text": "Add tests for this change", "priority": 0},
                            {"id": f"s_{turn_counter}_2", "text": "Run quick checks", "priority": 1},
                        ],
                    },
                }
            )
            continue

        if method == "turn/steer":
            requested_thread_id = params.get("threadId")
            if requested_thread_id != thread_id or active_turn_id is None:
                _send(
                    {
                        "jsonrpc": "2.0",
                        "id": msg_id,
                        "error": {
                            "code": -32011,
                            "message": "no active turn to steer",
                            "data": None,
                        },
                    }
                )
                continue

            steer_text = params.get("text") or ""
            _send({"jsonrpc": "2.0", "id": msg_id, "result": {"accepted": True}})
            _send(
                {
                    "jsonrpc": "2.0",
                    "method": "item/agentMessage/delta",
                    "params": {
                        "threadId": thread_id,
                        "turnId": active_turn_id,
                        "itemId": "msg_steer_1",
                        "delta": f"Steered: {steer_text}",
                    },
                }
            )
            _send(
                {
                    "jsonrpc": "2.0",
                    "method": "turn/completed",
                    "params": {"threadId": thread_id, "turn": {"id": active_turn_id, "status": "completed"}},
                }
            )
            active_turn_id = None
            continue

        _send(
            {
                "jsonrpc": "2.0",
                "id": msg_id,
                "error": {"code": -32601, "message": f"method not found: {method}", "data": None},
            }
        )

    return 0


if __name__ == "__main__":
    raise SystemExit(_main())
