name: release-dmg

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Optional version label when running manually"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-notarize-release:
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      HOMEBREW_NO_AUTO_UPDATE: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Swift 6 toolchain
        run: |
          set -euo pipefail
          CANDIDATES=(
            "/Applications/Xcode_16.4.app/Contents/Developer"
            "/Applications/Xcode_16.3.app/Contents/Developer"
            "/Applications/Xcode_16.2.app/Contents/Developer"
            "/Applications/Xcode_16.1.app/Contents/Developer"
            "/Applications/Xcode_16.0.app/Contents/Developer"
            "$(xcode-select -p)"
          )
          SELECTED=""
          for CANDIDATE in "${CANDIDATES[@]}"; do
            if [[ -d "$CANDIDATE" ]] && DEVELOPER_DIR="$CANDIDATE" swift --version | grep -q "Swift version 6"; then
              SELECTED="$CANDIDATE"
              break
            fi
          done
          if [[ -n "$SELECTED" ]]; then
            echo "DEVELOPER_DIR=$SELECTED" >> "$GITHUB_ENV"
            export DEVELOPER_DIR="$SELECTED"
          fi
          xcodebuild -version || true
          swift --version || true
          if ! swift --version | grep -q "Swift version 6"; then
            ls -1 /Applications | grep '^Xcode' || true
            echo "Swift 6 toolchain required for release build." >&2
            exit 1
          fi

      - name: Verify Apple Silicon runner
        run: |
          set -euo pipefail
          ARCH="$(uname -m)"
          if [[ "$ARCH" != "arm64" ]]; then
            echo "Apple Silicon runner required. Got: $ARCH" >&2
            exit 1
          fi

      - name: Resolve version
        run: |
          VERSION="${GITHUB_REF_NAME:-}"
          if [[ -z "$VERSION" || "$VERSION" == "$GITHUB_SHA" ]]; then
            VERSION="${{ inputs.version }}"
          fi
          if [[ -z "$VERSION" ]]; then
            VERSION="build-${GITHUB_RUN_NUMBER}"
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Import Developer ID certificate
        env:
          APPLE_DEVELOPER_ID_CERT_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_CERT_P12_BASE64 }}
          APPLE_DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERT_PASSWORD }}
          APPLE_KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          [[ -n "$APPLE_DEVELOPER_ID_CERT_P12_BASE64" ]] || { echo "Missing secret: APPLE_DEVELOPER_ID_CERT_P12_BASE64" >&2; exit 1; }
          [[ -n "$APPLE_DEVELOPER_ID_CERT_PASSWORD" ]] || { echo "Missing secret: APPLE_DEVELOPER_ID_CERT_PASSWORD" >&2; exit 1; }
          [[ -n "$APPLE_KEYCHAIN_PASSWORD" ]] || { echo "Missing secret: APPLE_KEYCHAIN_PASSWORD" >&2; exit 1; }

          CERT_PATH="$RUNNER_TEMP/developer-id.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/release-signing.keychain-db"
          echo "CI_SIGNING_KEYCHAIN=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

          echo "$APPLE_DEVELOPER_ID_CERT_P12_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$APPLE_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$APPLE_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$APPLE_DEVELOPER_ID_CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$APPLE_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Write App Store Connect notary key
        env:
          APPLE_NOTARY_API_KEY_P8_BASE64: ${{ secrets.APPLE_NOTARY_API_KEY_P8_BASE64 }}
          APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
        run: |
          set -euo pipefail
          [[ -n "$APPLE_NOTARY_API_KEY_P8_BASE64" ]] || { echo "Missing secret: APPLE_NOTARY_API_KEY_P8_BASE64" >&2; exit 1; }
          [[ -n "$APPLE_NOTARY_KEY_ID" ]] || { echo "Missing secret: APPLE_NOTARY_KEY_ID" >&2; exit 1; }

          mkdir -p "$RUNNER_TEMP/notary"
          NOTARY_KEY_FILE="$RUNNER_TEMP/notary/AuthKey_${APPLE_NOTARY_KEY_ID}.p8"
          echo "$APPLE_NOTARY_API_KEY_P8_BASE64" | base64 --decode > "$NOTARY_KEY_FILE"
          chmod 600 "$NOTARY_KEY_FILE"
          echo "NOTARY_KEY_FILE=$NOTARY_KEY_FILE" >> "$GITHUB_ENV"

      - name: Build, notarize, and staple DMG
        env:
          VERSION: ${{ env.VERSION }}
          CODESIGN_IDENTITY: ${{ secrets.APPLE_CODESIGN_IDENTITY }}
          NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
          NOTARY_ISSUER_ID: ${{ secrets.APPLE_NOTARY_ISSUER_ID }}
          NOTARY_KEY_FILE: ${{ env.NOTARY_KEY_FILE }}
        run: |
          set -euo pipefail
          [[ -n "$CODESIGN_IDENTITY" ]] || { echo "Missing secret: APPLE_CODESIGN_IDENTITY" >&2; exit 1; }
          [[ -n "$NOTARY_ISSUER_ID" ]] || { echo "Missing secret: APPLE_NOTARY_ISSUER_ID" >&2; exit 1; }
          ./scripts/release/build-notarized-dmg.sh

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: CodexChat-${{ env.VERSION }}-macos
          path: |
            dist/*.dmg
            dist/*.sha256

      - name: Attach artifacts to GitHub release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.sha256

      - name: Cleanup signing keychain
        if: always()
        run: |
          if [[ -n "${CI_SIGNING_KEYCHAIN:-}" && -f "$CI_SIGNING_KEYCHAIN" ]]; then
            security delete-keychain "$CI_SIGNING_KEYCHAIN" || true
          fi
